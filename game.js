"use strict";console.clear();class Stage{constructor(){this.render=function(){this.renderer.render(this.scene,this.camera)},this.add=function(t){this.scene.add(t)},this.remove=function(t){this.scene.remove(t)},this.container=document.getElementById("game"),this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor("#FAF1E7",1),this.container.appendChild(this.renderer.domElement),this.scene=new THREE.Scene;let t=window.innerWidth/window.innerHeight;this.camera=new THREE.OrthographicCamera(-20*t,20*t,20,-20,-100,1e3),this.camera.position.x=2,this.camera.position.y=2,this.camera.position.z=2,this.camera.lookAt(new THREE.Vector3(0,0,0)),this.light=new THREE.DirectionalLight(16777215,.5),this.light.position.set(0,499,0),this.scene.add(this.light),this.softLight=new THREE.AmbientLight(16777215,.4),this.scene.add(this.softLight),window.addEventListener("resize",(()=>this.onResize())),this.onResize()}setCamera(t,i=.3){TweenLite.to(this.camera.position,i,{y:t+4,ease:Power1.easeInOut}),TweenLite.to(this.camera.lookAt,i,{y:t,ease:Power1.easeInOut})}onResize(){this.renderer.setSize(window.innerWidth,window.innerHeight),this.camera.left=window.innerWidth/-30,this.camera.right=window.innerWidth/30,this.camera.top=window.innerHeight/30,this.camera.bottom=window.innerHeight/-30,this.camera.updateProjectionMatrix()}}class Block{constructor(t){if(this.STATES={ACTIVE:"active",STOPPED:"stopped",MISSED:"missed"},this.MOVE_AMOUNT=12,this.dimension={width:0,height:0,depth:0},this.position={x:0,y:0,z:0},this.targetBlock=t,this.index=(this.targetBlock?this.targetBlock.index:0)+1,this.workingPlane=this.index%2?"x":"z",this.workingDimension=this.index%2?"width":"depth",this.dimension.width=this.targetBlock?this.targetBlock.dimension.width:10,this.dimension.height=this.targetBlock?this.targetBlock.dimension.height:2,this.dimension.depth=this.targetBlock?this.targetBlock.dimension.depth:10,this.position.x=this.targetBlock?this.targetBlock.position.x:0,this.position.y=this.dimension.height*this.index,this.position.z=this.targetBlock?this.targetBlock.position.z:0,this.colorOffset=this.targetBlock?this.targetBlock.colorOffset:Math.round(100*Math.random()),this.targetBlock){let t=this.index+this.colorOffset;var i=55*Math.sin(.3*t)+200,e=55*Math.sin(.3*t+2)+200,s=55*Math.sin(.3*t+4)+200;this.color=new THREE.Color(i/255,e/255,s/255)}else this.color=3355460;this.state=this.index>1?this.STATES.ACTIVE:this.STATES.STOPPED,this.speed=-.1-.005*this.index,this.speed<-4&&(this.speed=-4),this.direction=this.speed;let n=new THREE.BoxGeometry(this.dimension.width,this.dimension.height,this.dimension.depth);n.applyMatrix((new THREE.Matrix4).makeTranslation(this.dimension.width/2,this.dimension.height/2,this.dimension.depth/2)),this.material=new THREE.MeshToonMaterial({color:this.color,shading:THREE.FlatShading}),this.mesh=new THREE.Mesh(n,this.material),this.mesh.position.set(this.position.x,this.position.y+(this.state,this.STATES.ACTIVE,0),this.position.z),this.state==this.STATES.ACTIVE&&(this.position[this.workingPlane]=Math.random()>.5?-this.MOVE_AMOUNT:this.MOVE_AMOUNT)}reverseDirection(){this.direction=this.direction>0?this.speed:Math.abs(this.speed)}place(){this.state=this.STATES.STOPPED;let t=this.targetBlock.dimension[this.workingDimension]-Math.abs(this.position[this.workingPlane]-this.targetBlock.position[this.workingPlane]),i={plane:this.workingPlane,direction:this.direction};if(this.dimension[this.workingDimension]-t<.3&&(t=this.dimension[this.workingDimension],i.bonus=!0,this.position.x=this.targetBlock.position.x,this.position.z=this.targetBlock.position.z,this.dimension.width=this.targetBlock.dimension.width,this.dimension.depth=this.targetBlock.dimension.depth),t>0){let e={width:this.dimension.width,height:this.dimension.height,depth:this.dimension.depth};e[this.workingDimension]-=t,this.dimension[this.workingDimension]=t;let s=new THREE.BoxGeometry(this.dimension.width,this.dimension.height,this.dimension.depth);s.applyMatrix((new THREE.Matrix4).makeTranslation(this.dimension.width/2,this.dimension.height/2,this.dimension.depth/2));let n=new THREE.Mesh(s,this.material),h=new THREE.BoxGeometry(e.width,e.height,e.depth);h.applyMatrix((new THREE.Matrix4).makeTranslation(e.width/2,e.height/2,e.depth/2));let o=new THREE.Mesh(h,this.material),a={x:this.position.x,y:this.position.y,z:this.position.z};this.position[this.workingPlane]<this.targetBlock.position[this.workingPlane]?this.position[this.workingPlane]=this.targetBlock.position[this.workingPlane]:a[this.workingPlane]+=t,n.position.set(this.position.x,this.position.y,this.position.z),o.position.set(a.x,a.y,a.z),i.placed=n,i.bonus||(i.chopped=o)}else this.state=this.STATES.MISSED;return this.dimension[this.workingDimension]=t,i}tick(){if(this.state==this.STATES.ACTIVE){let t=this.position[this.workingPlane];(t>this.MOVE_AMOUNT||t<-this.MOVE_AMOUNT)&&this.reverseDirection(),this.position[this.workingPlane]+=this.direction,this.mesh.position[this.workingPlane]=this.position[this.workingPlane]}}}class Game{constructor(){this.STATES={LOADING:"loading",PLAYING:"playing",READY:"ready",ENDED:"ended",RESETTING:"resetting"},this.blocks=[],this.state=this.STATES.LOADING,this.stage=new Stage,this.mainContainer=document.getElementById("container"),this.scoreContainer=document.getElementById("score"),this.startButton=document.getElementById("start-button"),this.instructions=document.getElementById("instructions"),this.scoreContainer.innerHTML="0",this.newBlocks=new THREE.Group,this.placedBlocks=new THREE.Group,this.choppedBlocks=new THREE.Group,this.stage.add(this.newBlocks),this.stage.add(this.placedBlocks),this.stage.add(this.choppedBlocks),this.addBlock(),this.tick(),this.updateState(this.STATES.READY),document.addEventListener("keydown",(t=>{32==t.keyCode&&this.onAction()})),document.addEventListener("click",(t=>{this.onAction()})),document.addEventListener("touchstart",(t=>{t.preventDefault()}))}updateState(t){for(let t in this.STATES)this.mainContainer.classList.remove(this.STATES[t]);this.mainContainer.classList.add(t),this.state=t}onAction(){switch(this.state){case this.STATES.READY:this.startGame();break;case this.STATES.PLAYING:this.placeBlock();break;case this.STATES.ENDED:this.restartGame()}}startGame(){this.state!=this.STATES.PLAYING&&(this.scoreContainer.innerHTML="0",this.updateState(this.STATES.PLAYING),this.addBlock())}restartGame(){this.updateState(this.STATES.RESETTING);let t=this.placedBlocks.children,i=.02;for(let e=0;e<t.length;e++)TweenLite.to(t[e].scale,.2,{x:0,y:0,z:0,delay:(t.length-e)*i,ease:Power1.easeIn,onComplete:()=>this.placedBlocks.remove(t[e])}),TweenLite.to(t[e].rotation,.2,{y:.5,delay:(t.length-e)*i,ease:Power1.easeIn});let e=.4+t.length*i;this.stage.setCamera(2,e);let s={value:this.blocks.length-1};TweenLite.to(s,e,{value:0,onUpdate:()=>{this.scoreContainer.innerHTML=String(Math.round(s.value))}}),this.blocks=this.blocks.slice(0,1),setTimeout((()=>{this.startGame()}),1e3*e)}placeBlock(){let t=this.blocks[this.blocks.length-1],i=t.place();if(this.newBlocks.remove(t.mesh),i.placed&&this.placedBlocks.add(i.placed),i.chopped){this.choppedBlocks.add(i.chopped);let t={y:"-=30",ease:Power1.easeIn,onComplete:()=>this.choppedBlocks.remove(i.chopped)},e=10,s={delay:.05,x:"z"==i.plane?Math.random()*e-e/2:.1,z:"x"==i.plane?Math.random()*e-e/2:.1,y:.1*Math.random()};i.chopped.position[i.plane]>i.placed.position[i.plane]?t[i.plane]="+="+40*Math.abs(i.direction):t[i.plane]="-="+40*Math.abs(i.direction),TweenLite.to(i.chopped.position,1,t),TweenLite.to(i.chopped.rotation,1,s)}this.addBlock()}addBlock(){let t=this.blocks[this.blocks.length-1];if(t&&t.state==t.STATES.MISSED)return this.endGame();this.scoreContainer.innerHTML=String(this.blocks.length-1);let i=new Block(t);this.newBlocks.add(i.mesh),this.blocks.push(i),this.stage.setCamera(2*this.blocks.length),this.blocks.length>=5&&this.instructions.classList.add("hide")}endGame(){this.updateState(this.STATES.ENDED)}tick(){this.blocks[this.blocks.length-1].tick(),this.stage.render(),requestAnimationFrame((()=>{this.tick()}))}}let game=new Game;